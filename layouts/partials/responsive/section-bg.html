{{/* 
  Responsive Section Background Partial
  
  Usage with image:
  {{ partial "responsive/section-bg.html" (dict 
    "src" "images/hero.jpg"
    "class" "section hero inverse bg-blue section--padding"
    "containerWidth" 100
    "opacity" 0.6
    "bgSize" "cover"
    "bgRepeat" "no-repeat"
    "bgPosition" "center"
  ) }}
  
  Usage with solid color:
  {{ partial "responsive/section-bg.html" (dict 
    "class" "section bg-blue section--padding"
    "containerWidth" 100
    "bgColor" "#ff6b6b"
  ) }}
  
  Usage with linear gradient:
  {{ partial "responsive/section-bg.html" (dict 
    "class" "section bg-blue section--padding"
    "containerWidth" 100
    "linearGradient" (dict "angle" "45deg" "from" "#f0eee6" "to" "#faf9f5")
  ) }}
  
  Usage with radial gradient:
  {{ partial "responsive/section-bg.html" (dict 
    "class" "section bg-blue section--padding"
    "containerWidth" 100
    "radialGradient" (dict "shape" "circle" "from" "#ff6b6b" "to" "#4ecdc4" "position" "center")
  ) }}
  
  Usage with multiple gradient stops:
  {{ partial "responsive/section-bg.html" (dict 
    "class" "section bg-blue section--padding"
    "containerWidth" 100
    "linearGradient" (dict 
      "angle" "135deg" 
      "stops" (slice 
        (dict "color" "#667eea" "position" "0%")
        (dict "color" "#764ba2" "position" "100%")
      )
    )
  ) }}

    <div class="container container--lg">
      <!-- Your section content here -->
    </div>
  </section>
  
  Opens a <section> tag with:
  - Responsive background image (processed by Hugo) OR
  - Solid background color OR 
  - Linear/radial gradients with multiple stops
  - Custom CSS classes
  - Background styling options
  - Leaves section open for you to add content and close manually
*/}}

{{- $src := .src -}}
{{- $class := .class | default "section" -}}
{{- $containerWidth := .containerWidth | default 100 -}}
{{- $opacity := .opacity | default 1 -}}
{{- $bgSize := .bgSize | default "cover" -}}
{{- $bgRepeat := .bgRepeat | default "no-repeat" -}}
{{- $bgPosition := .bgPosition | default "center" -}}
{{- $bgColor := .bgColor -}}
{{- $linearGradient := .linearGradient -}}
{{- $radialGradient := .radialGradient -}}

{{/* Generate unique class name for styling */}}
{{- $uniqueClass := "" -}}
{{- if $src -}}
  {{- $uniqueClass = printf "section-bg-%s" (substr (md5 $src) 0 8) -}}
{{- else if $bgColor -}}
  {{- $uniqueClass = printf "section-bg-%s" (substr (md5 $bgColor) 0 8) -}}
{{- else if $linearGradient -}}
  {{- $gradientString := printf "%v" $linearGradient -}}
  {{- $uniqueClass = printf "section-bg-%s" (substr (md5 $gradientString) 0 8) -}}
{{- else if $radialGradient -}}
  {{- $gradientString := printf "%v" $radialGradient -}}
  {{- $uniqueClass = printf "section-bg-%s" (substr (md5 $gradientString) 0 8) -}}
{{- else -}}
  {{- $uniqueClass = printf "section-bg-%s" (substr (md5 (string now.Unix)) 0 8) -}}
{{- end -}}

{{/* Handle solid color background */}}
{{- if $bgColor -}}
  <style>
  .{{ $uniqueClass }} {
    background-color: {{ $bgColor | safeHTML }};
    position: relative;
  }
  </style>
  
  <section class="{{ $class }} {{ $uniqueClass }}">

{{/* Handle linear gradient background */}}
{{- else if $linearGradient -}}
  {{- $angle := $linearGradient.angle | default "to bottom" -}}
  {{- $from := $linearGradient.from -}}
  {{- $to := $linearGradient.to -}}
  {{- $stops := $linearGradient.stops -}}
  
  {{- $gradientValue := "" -}}
  {{- if $stops -}}
    {{/* Handle multiple stops */}}
    {{- $stopStrings := slice -}}
    {{- range $stops -}}
      {{- $stopString := .color -}}
      {{- if .position -}}
        {{- $stopString = printf "%s %s" .color .position -}}
      {{- end -}}
      {{- $stopStrings = $stopStrings | append $stopString -}}
    {{- end -}}
    {{- $gradientValue = printf "linear-gradient(%s, %s)" $angle (delimit $stopStrings ", ") -}}
  {{- else if and $from $to -}}
    {{/* Handle simple from/to gradient */}}
    {{- $gradientValue = printf "linear-gradient(%s, %s, %s)" $angle $from $to -}}
  {{- else -}}
    {{/* Fallback to transparent */}}
    {{- $gradientValue = "linear-gradient(to bottom, transparent, transparent)" -}}
  {{- end -}}
  
  <style>
  .{{ $uniqueClass }} {
    background: {{ $gradientValue | safeCSS }};
    position: relative;
  }
  </style>
  
  <section class="{{ $class }} {{ $uniqueClass }}">

{{/* Handle radial gradient background */}}
{{- else if $radialGradient -}}
  {{- $shape := $radialGradient.shape | default "ellipse" -}}
  {{- $position := $radialGradient.position | default "center" -}}
  {{- $from := $radialGradient.from -}}
  {{- $to := $radialGradient.to -}}
  {{- $stops := $radialGradient.stops -}}
  
  {{- $gradientValue := "" -}}
  {{- if $stops -}}
    {{/* Handle multiple stops */}}
    {{- $stopStrings := slice -}}
    {{- range $stops -}}
      {{- $stopString := .color -}}
      {{- if .position -}}
        {{- $stopString = printf "%s %s" .color .position -}}
      {{- end -}}
      {{- $stopStrings = $stopStrings | append $stopString -}}
    {{- end -}}
    {{- $gradientValue = printf "radial-gradient(%s at %s, %s)" $shape $position (delimit $stopStrings ", ") -}}
  {{- else if and $from $to -}}
    {{/* Handle simple from/to gradient */}}
    {{- $gradientValue = printf "radial-gradient(%s at %s, %s, %s)" $shape $position $from $to -}}
  {{- else -}}
    {{/* Fallback to transparent */}}
    {{- $gradientValue = "radial-gradient(circle at center, transparent, transparent)" -}}
  {{- end -}}
  
  <style>
  .{{ $uniqueClass }} {
    background: {{ $gradientValue | safeCSS }};
    position: relative;
  }
  </style>
  
  <section class="{{ $class }} {{ $uniqueClass }}">

{{/* Handle image background (original functionality) */}}
{{- else if $src -}}
  {{/* Check if image is SVG */}}
  {{- $isSVG := eq (path.Ext $src) ".svg" -}}

  {{/* Check if image is remote */}}
  {{- $isRemote := or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}

  {{/* Handle SVG case - use original image */}}
  {{- if $isSVG -}}
    <style>
    .{{ $uniqueClass }} {
      background-image: url('{{ $src }}');
      background-size: {{ $bgSize | safeCSS }};
      background-repeat: {{ $bgRepeat | safeCSS }};
      background-position: {{ $bgPosition | safeCSS }};
      position: relative;
    }
    
    .{{ $uniqueClass }} picture {
      /* Allow picture to flow normally with content */
    }
    
    .{{ $uniqueClass }} picture img {
      width: 100%;
      height: auto;
    }
    </style>
    
    <section class="{{ $class }} {{ $uniqueClass }}">
  {{- else -}}
    {{/* Get the image resource */}}
    {{- $image := "" -}}
    {{- if $isRemote -}}
      {{- $tryResult := try (resources.GetRemote $src) -}}
      {{- if $tryResult -}}
        {{- $image = $tryResult.Value -}}
      {{- else -}}
        {{/* Fallback if remote image fails to load */}}
        <style>
        .{{ $uniqueClass }} {
          background-image: url('{{ $src }}');
          background-size: {{ $bgSize | safeCSS }};
          background-repeat: {{ $bgRepeat | safeCSS }};
          background-position: {{ $bgPosition | safeCSS }};
          position: relative;
        }
        
        .{{ $uniqueClass }} picture {
          /* Allow picture to flow normally with content */
        }
        
        .{{ $uniqueClass }} picture img {
          width: 100%;
          height: auto;
        }
        </style>
        
        <section class="{{ $class }} {{ $uniqueClass }}">
      {{- end -}}
    {{- else -}}
      {{- $image = resources.Get $src -}}
    {{- end -}}

    {{- if $image -}}
      {{/* Calculate container width for optimal background image size */}}
      {{- $getContainerWidth := "" -}}
      {{- if reflect.IsMap $containerWidth -}}
        {{- $getContainerWidth = $containerWidth -}}
      {{- else -}}
        {{- $getContainerWidth = dict "desktop" $containerWidth "tablet" $containerWidth "mobile" $containerWidth -}}
      {{- end -}}

      {{/* Get container widths with defaults */}}
      {{- $desktopWidth := index $getContainerWidth "desktop" | default 100 -}}
      {{- $tabletWidth := index $getContainerWidth "tablet" | default 100 -}}
      {{- $mobileWidth := index $getContainerWidth "mobile" | default 100 -}}

      {{/* Calculate optimal image size for background (use largest needed size) */}}
      {{- $desktopSize := div (mul 1200 $desktopWidth) 100 -}}
      {{- $tabletSize := div (mul 900 $tabletWidth) 100 -}}
      {{- $mobileSize := div (mul 600 $mobileWidth) 100 -}}
      
      {{/* Use the largest size needed for the background image */}}
      {{- $maxSize := $desktopSize -}}
      {{- if gt $tabletSize $maxSize -}}{{ $maxSize = $tabletSize }}{{- end -}}
      {{- if gt $mobileSize $maxSize -}}{{ $maxSize = $mobileSize }}{{- end -}}
      
      {{/* Generate optimized background image with opacity filter */}}
      {{- $bgImage := $image.Resize (printf "%dx" $maxSize) -}}
      {{- if ne $opacity 1 -}}
          {{- $bgImage = $bgImage.Filter (images.Opacity $opacity) -}}
      {{- end -}}
      
      <style>
      .{{ $uniqueClass }} {
        background-image: url('{{ $bgImage.RelPermalink }}');
        background-size: {{ $bgSize }};
        background-repeat: {{ $bgRepeat }};
        background-position: {{ $bgPosition }};
        position: relative;
      }
      
      .{{ $uniqueClass }} picture {
        /* Allow picture to flow normally with content */
      }
      
      .{{ $uniqueClass }} picture img {
        width: 100%;
        height: auto;
      }
      </style>
      
      <section class="{{ $class }} {{ $uniqueClass }}">
    {{- else -}}
      {{/* Fallback if image resource not found */}}
      <style>
      .{{ $uniqueClass }} {
        background-image: url('{{ $src }}');
        background-size: {{ $bgSize }};
        background-repeat: {{ $bgRepeat }};
        background-position: {{ $bgPosition }};
        position: relative;
      }
      
      .{{ $uniqueClass }} picture {
        /* Allow picture to flow normally with content */
      }
      
      .{{ $uniqueClass }} picture img {
        width: 100%;
        height: auto;
      }
      </style>
      
      <section class="{{ $class }} {{ $uniqueClass }}">
    {{- end -}}
  {{- end -}}

{{/* Fallback - empty section with just classes */}}
{{- else -}}
  <section class="{{ $class }}">
{{- end -}}