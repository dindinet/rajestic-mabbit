{{/* 
  Responsive Section Background Partial
  
  Usage:
  {{ partial "responsive/section-bg.html" (dict 
    "src" "images/hero.jpg"
    "class" "section hero inverse bg-blue section--padding"
    "containerWidth" 100
    "opacity" 0.6
    "bgSize" "cover"
    "bgRepeat" "no-repeat"
    "bgPosition" "center"
  ) }}
    <div class="container container--lg">
      <!-- Your section content here -->
    </div>
  </section>
  
  Opens a <section> tag with:
  - Responsive background image (processed by Hugo)
  - Custom CSS classes
  - Background styling options
  - Leaves section open for you to add content and close manually
*/}}

{{- $src := .src -}}
{{- $class := .class | default "section" -}}
{{- $containerWidth := .containerWidth | default 100 -}}
{{- $opacity := .opacity | default 1 -}}
{{- $bgSize := .bgSize | default "cover" -}}
{{- $bgRepeat := .bgRepeat | default "no-repeat" -}}
{{- $bgPosition := .bgPosition | default "center" -}}

{{/* Generate unique class name for styling */}}
{{- $uniqueClass := printf "section-bg-%s" (substr (md5 $src) 0 8) -}}

{{/* Check if image is SVG */}}
{{- $isSVG := eq (path.Ext $src) ".svg" -}}

{{/* Check if image is remote */}}
{{- $isRemote := or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}

{{/* Handle SVG case - use original image */}}
{{- if $isSVG -}}
  <style>
  .{{ $uniqueClass }} {
    background-image: url('{{ $src }}');
    background-size: {{ $bgSize }};
    background-repeat: {{ $bgRepeat }};
    background-position: {{ $bgPosition }};
    position: relative;
  }
  
  .{{ $uniqueClass }} picture {
    /* Allow picture to flow normally with content */
  }
  
  .{{ $uniqueClass }} picture img {
    width: 100%;
    height: auto;
  }
  </style>
  
  <section class="{{ $class }} {{ $uniqueClass }}">
{{- else -}}
  {{/* Get the image resource */}}
  {{- $image := "" -}}
  {{- if $isRemote -}}
    {{- $tryResult := try (resources.GetRemote $src) -}}
    {{- if $tryResult -}}
      {{- $image = $tryResult.Value -}}
    {{- else -}}
      {{/* Fallback if remote image fails to load */}}
      <style>
      .{{ $uniqueClass }} {
        background-image: url('{{ $src }}');
        background-size: {{ $bgSize }};
        background-repeat: {{ $bgRepeat }};
        background-position: {{ $bgPosition }};
        position: relative;
      }
      
      .{{ $uniqueClass }} picture {
        /* Allow picture to flow normally with content */
      }
      
      .{{ $uniqueClass }} picture img {
        width: 100%;
        height: auto;
      }
      </style>
      
      <section class="{{ $class }} {{ $uniqueClass }}">
    {{- end -}}
  {{- else -}}
    {{- $image = resources.Get $src -}}
  {{- end -}}

  {{- if $image -}}
    {{/* Calculate container width for optimal background image size */}}
    {{- $getContainerWidth := "" -}}
    {{- if reflect.IsMap $containerWidth -}}
      {{- $getContainerWidth = $containerWidth -}}
    {{- else -}}
      {{- $getContainerWidth = dict "desktop" $containerWidth "tablet" $containerWidth "mobile" $containerWidth -}}
    {{- end -}}

    {{/* Get container widths with defaults */}}
    {{- $desktopWidth := index $getContainerWidth "desktop" | default 100 -}}
    {{- $tabletWidth := index $getContainerWidth "tablet" | default 100 -}}
    {{- $mobileWidth := index $getContainerWidth "mobile" | default 100 -}}

    {{/* Calculate optimal image size for background (use largest needed size) */}}
    {{- $desktopSize := div (mul 1200 $desktopWidth) 100 -}}
    {{- $tabletSize := div (mul 900 $tabletWidth) 100 -}}
    {{- $mobileSize := div (mul 600 $mobileWidth) 100 -}}
    
    {{/* Use the largest size needed for the background image */}}
    {{- $maxSize := $desktopSize -}}
    {{- if gt $tabletSize $maxSize -}}{{ $maxSize = $tabletSize }}{{- end -}}
    {{- if gt $mobileSize $maxSize -}}{{ $maxSize = $mobileSize }}{{- end -}}
    
    {{/* Generate optimized background image with opacity filter */}}
    {{- $bgImage := $image.Resize (printf "%dx" $maxSize) -}}
    {{- if ne $opacity 1 -}}
        {{- $bgImage = $bgImage.Filter (images.Opacity $opacity) -}}
    {{- end -}}
    
    <style>
    .{{ $uniqueClass }} {
      background-image: url('{{ $bgImage.RelPermalink }}');
      background-size: {{ $bgSize }};
      background-repeat: {{ $bgRepeat }};
      background-position: {{ $bgPosition }};
      position: relative;
    }
    
    .{{ $uniqueClass }} picture {
      /* Allow picture to flow normally with content */
    }
    
    .{{ $uniqueClass }} picture img {
      width: 100%;
      height: auto;
    }
    </style>
    
    <section class="{{ $class }} {{ $uniqueClass }}">
  {{- else -}}
    {{/* Fallback if image resource not found */}}
    <style>
    .{{ $uniqueClass }} {
      background-image: url('{{ $src }}');
      background-size: {{ $bgSize }};
      background-repeat: {{ $bgRepeat }};
      background-position: {{ $bgPosition }};
      position: relative;
    }
    
    .{{ $uniqueClass }} picture {
      /* Allow picture to flow normally with content */
    }
    
    .{{ $uniqueClass }} picture img {
      width: 100%;
      height: auto;
    }
    </style>
    
    <section class="{{ $class }} {{ $uniqueClass }}">
  {{- end -}}
{{- end -}}